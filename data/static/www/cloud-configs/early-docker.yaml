#cloud-config

coreos:
  - name: early-docker.socket
    command: start
    content: |
      [Unit]
      Description=Early Docker Socket for the API

      [Socket]
      ListenStream=/var/run/early-docker.sock

      [Install]
      WantedBy=sockets.target
	- name: early-docker.service
    command: start
    content: |
    	[Unit]
    	Description=Early Docker Application Container Engine
    	Documentation=http://docs.docker.com
    	After=early-docker.socket
    	Requires=early-docker.socket

    	[Service]
    	Environment=TMPDIR=/var/tmp
    	MountFlags=slave
    	LimitNOFILE=1048576
    	LimitNPROC=1048576
    	ExecStart=/usr/lib/coreos/dockerd --daemon --insecure-registry 172.16.16.15:5000 --host=fd:// \
        --bridge=none --iptables=false --ip-masq=false --graph=/var/li

    	[Install]
    	WantedBy=early-docker.target
  - name: flanneld.service
    command: start
    content: |
      Unit]
      Description=Network fabric for containers
      Documentation=https://github.com/coreos/flannel
      Requires=early-docker.service
      After=etcd.service etcd2.service early-docker.service
      Before=early-docker.target

      [Service]
      Type=notify
      Restart=always
      RestartSec=5
      Environment="TMPDIR=/var/tmp/"
      Environment="DOCKER_HOST=unix:///var/run/early-docker.sock"
      Environment="FLANNEL_VER=0.4.1"
      Environment="ETCD_SSL_DIR=/etc/ssl/etcd"
      LimitNOFILE=40000
      LimitNPROC=1048576
      ExecStartPre=/sbin/modprobe ip_tables
      ExecStartPre=/usr/bin/mkdir -p /run/flannel
      ExecStartPre=/usr/bin/mkdir -p ${ETCD_SSL_DIR}
      ExecStartPre=/usr/bin/touch /run/flannel/options.env

      ExecStart=/usr/libexec/sdnotify-proxy /run/flannel/sd.sock \
        /usr/bin/docker run --net=host --privileged=true --rm \
        --volume=/run/flannel:/run/flannel \
        --env=NOTIFY_SOCKET=/run/flannel/sd.sock \
        --env-file=/run/flannel/options.env \
        --volume=/usr/share/ca-certificates:/etc/ssl/certs:ro \
        --volume=${ETCD_SSL_DIR}:/etc/ssl/etcd:ro \
        172.16.16.15:5000/flannel:${FLANNEL_VER} /opt/bin/flanneld --ip-masq=true

      # Update docker options
      ExecStartPost=/usr/bin/docker run --net=host --rm -v /run:/run \
       172.16.16.15:5000/flannel:${FLANNEL_VER} \
        /opt/bin/mk-docker-opts.sh -d /run/flannel_docker_opts.env -i
