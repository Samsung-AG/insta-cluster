#cloud-config

---
coreos:
  etcd2:
    proxy: readonly
    data-dir: /var/lib/etcd2/
    initial-cluster-token: etcd-cluster
    listen-client-urls: http://127.0.0.1:2379,http://127.0.0.1:8080
    initial-cluster: etcd01=http://172.16.16.15:2380
  fleet:
    etcd-servers: http://172.16.16.15:2379
    metadata: "role=peon,kube-role=node"
    public-ip: 172.16.16.20
  units:
  - name: etcd2.service
    enabled: true
  - name: fleet.service
    command: start
  - flannel:
      etcd-endpoints: http://172.16.16.15:4001
      interface: enp0s25
  - name: docker-tcp.socket
    command: start
    content: |
      [Unit]
      Description=Docker Socket for the API

      [Socket]
      ListenStream=2375
      Service=docker.service
      BindIPv6Only=both

      [Install]
      WantedBy=sockets.target
  - name: setup-network-environment.service
    command: start
    content: |
      [Unit]
      Description=Setup Network Environment
      Documentation=https://github.com/kelseyhightower/setup-network-environment
      Requires=network-online.target
      After=network-online.target
      Before=flanneld.service

      [Service]
      ExecStartPre=-/usr/bin/mkdir -p /opt/bin
      ExecStartPre=/usr/bin/wget -N -P /opt/bin http://172.16.16.15/kubernetes/setup-network-environment
      ExecStartPre=/usr/bin/chmod +x /opt/bin/setup-network-environment
      ExecStart=/opt/bin/setup-network-environment
      RemainAfterExit=yes
      Type=oneshot
  - name: enable-docker-tcp.service
    command: start
    content: |
      [Unit]
      Description=Enable the Docker Socket for the API

      [Service]
      Type=oneshot
      ExecStart=/usr/bin/systemctl enable docker-tcp.socket
  - name: docker.service
    command: restart
    content: |
      [Unit]
      Description=Docker Application Container Engine 
      Documentation=http://docs.docker.io
      After=network.target
      [Service]
      ExecStartPre=/bin/mount --make-rprivate /
      # Run docker but don't have docker automatically restart
      # containers. This is a job for systemd and unit files.
      ExecStart=/usr/bin/docker -d -H fd://  --insecure-registry 172.16.16.15:5000

      [Install]
      WantedBy=multi-user.target
ssh-authorized-keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC1WXArdPrWtw4hoUsSZOFLUqPmrciREYuSqPoyek1fxv+NsDy5kJ4khserlFLs5HkPe6MBi2vlF1wBp3dg5XcKClUyRShCadmNbiOvGJoafqoP5btUhDdaFkYfPLhQ7S0IN5Vitk2YvmDLMnfnujkKKtQojRwIuBx0udxmigGjIu16C46LbNeTCzoJVm2dSl1lsG7IouQHcjgh77RM1HV81dNEPQrb/id6ICELppqfwK6j9fRoa8Yh33xhOALb50h71ma0EUGsTFBFaa372438aoFZOrIOLpOLEn36lDTXKnRrBQXlirt6o3kxSwM37Z1jRmsdA0UOtL5oNFPYmBJf leetchang@gmail.com